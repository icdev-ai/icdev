# [TEMPLATE: CUI // SP-CTI]
# ICDEV Docker Compose — GovCloud Full Profile (all services enabled)
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose up -d icdev-dashboard    # Start only the dashboard
#   docker compose logs -f icdev-dashboard  # Follow dashboard logs
#   docker compose down                     # Stop all services
#
# Customization:
#   - Comment out or remove services you don't need
#   - Create .env file with your secrets (see .env.template)
#   - Generate a custom docker-compose for your profile:
#       python tools/installer/platform_setup.py --generate docker --profile isv_startup
#
# Volumes:
#   icdev-data — Shared persistent volume mounted at /app/data in all containers.
#   Contains icdev.db, platform.db, memory.db, activity.db, and tenant databases.
#
# Networks:
#   icdev-net — Isolated bridge network for inter-agent A2A communication.

x-common-env: &common-env
  ICDEV_DB_PATH: /app/data/icdev.db
  ICDEV_PROJECT_ROOT: /app

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  start_period: 10s
  retries: 3

services:

  # ====================================================================
  # Database Initialization (one-time — runs init_icdev_db.py and exits)
  # ====================================================================
  icdev-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent-base
    image: icdev/agent-base:latest
    container_name: icdev-init
    environment:
      <<: *common-env
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    logging: *default-logging
    restart: "no"
    command: ["tools/db/init_icdev_db.py"]

  # ====================================================================
  # Core Tier
  # ====================================================================

  # Orchestrator Agent — task routing, workflow management
  icdev-orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.orchestrator
    image: icdev/orchestrator:latest
    container_name: icdev-orchestrator
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8443:8443"
    environment:
      <<: *common-env
      PORT: "8443"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8443/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    command: ["tools/a2a/agent_server.py", "--agent-id", "orchestrator-agent", "--port", "8443"]

  # Architect Agent — ATLAS/M-ATLAS A/T phases, system design
  icdev-architect:
    build:
      context: .
      dockerfile: docker/Dockerfile.architect
    image: icdev/architect:latest
    container_name: icdev-architect
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8444:8444"
    environment:
      <<: *common-env
      PORT: "8444"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8444/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    command: ["tools/a2a/agent_server.py", "--agent-id", "architect-agent", "--port", "8444"]

  # ====================================================================
  # Domain Tier
  # ====================================================================

  # Builder Agent — TDD code generation (RED-GREEN-REFACTOR)
  icdev-builder:
    build:
      context: .
      dockerfile: docker/Dockerfile.builder
    image: icdev/builder:latest
    container_name: icdev-builder
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8445:8445"
    environment:
      <<: *common-env
      PORT: "8445"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8445/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "builder-agent", "--port", "8445"]

  # Compliance Agent — ATO artifacts (SSP, POAM, STIG, SBOM, FedRAMP, CMMC)
  icdev-compliance:
    build:
      context: .
      dockerfile: docker/Dockerfile.compliance
    image: icdev/compliance:latest
    container_name: icdev-compliance
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8446:8446"
    environment:
      <<: *common-env
      PORT: "8446"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8446/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "compliance-agent", "--port", "8446"]

  # Security Agent — SAST, dependency audit, secret detection, container scan
  icdev-security:
    build:
      context: .
      dockerfile: docker/Dockerfile.security
    image: icdev/security:latest
    container_name: icdev-security
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8447:8447"
    environment:
      <<: *common-env
      PORT: "8447"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8447/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "security-agent", "--port", "8447"]

  # Infrastructure Agent — Terraform, Ansible, K8s, pipeline gen
  icdev-infrastructure:
    build:
      context: .
      dockerfile: docker/Dockerfile.infrastructure
    image: icdev/infrastructure:latest
    container_name: icdev-infrastructure
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8448:8448"
    environment:
      <<: *common-env
      PORT: "8448"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8448/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "infrastructure-agent", "--port", "8448"]

  # MBSE Agent — SysML parsing, DOORS NG, digital thread, model-code sync
  icdev-mbse:
    build:
      context: .
      dockerfile: docker/Dockerfile.mbse-agent
    image: icdev/mbse:latest
    container_name: icdev-mbse
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8451:8451"
    environment:
      <<: *common-env
      PORT: "8451"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8451/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "mbse-agent", "--port", "8451"]

  # Modernization Agent — Legacy analysis, 7R assessment, migration planning
  icdev-modernization:
    build:
      context: .
      dockerfile: docker/Dockerfile.modernization-agent
    image: icdev/modernization:latest
    container_name: icdev-modernization
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8452:8452"
    environment:
      <<: *common-env
      PORT: "8452"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8452/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "modernization-agent", "--port", "8452"]

  # Requirements Analyst Agent — Conversational intake, gap detection, SAFe decomposition
  icdev-requirements:
    build:
      context: .
      dockerfile: docker/Dockerfile.requirements-analyst-agent
    image: icdev/requirements:latest
    container_name: icdev-requirements
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8453:8453"
    environment:
      <<: *common-env
      PORT: "8453"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8453/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "requirements-analyst-agent", "--port", "8453"]

  # Supply Chain Agent — Dependency graph, SBOM aggregation, ISA lifecycle, CVE triage
  icdev-supply-chain:
    build:
      context: .
      dockerfile: docker/Dockerfile.supply-chain-agent
    image: icdev/supply-chain:latest
    container_name: icdev-supply-chain
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8454:8454"
    environment:
      <<: *common-env
      PORT: "8454"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8454/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "supply-chain-agent", "--port", "8454"]

  # Simulation Agent — Digital Program Twin, Monte Carlo, COA generation
  icdev-simulation:
    build:
      context: .
      dockerfile: docker/Dockerfile.simulation-agent
    image: icdev/simulation:latest
    container_name: icdev-simulation
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8455:8455"
    environment:
      <<: *common-env
      PORT: "8455"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8455/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    command: ["tools/a2a/agent_server.py", "--agent-id", "simulation-agent", "--port", "8455"]

  # Integration Agent — Jira, ServiceNow, GitLab sync, DOORS NG ReqIF export
  icdev-integration:
    build:
      context: .
      dockerfile: docker/Dockerfile.integration-agent
    image: icdev/integration:latest
    container_name: icdev-integration
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8456:8456"
    environment:
      <<: *common-env
      PORT: "8456"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8456/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "integration-agent", "--port", "8456"]

  # DevSecOps Agent — Pipeline security, ZTA maturity, policy-as-code
  icdev-devsecops:
    build:
      context: .
      dockerfile: docker/Dockerfile.devsecops-agent
    image: icdev/devsecops:latest
    container_name: icdev-devsecops
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8457:8457"
    environment:
      <<: *common-env
      PORT: "8457"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8457/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "devsecops-agent", "--port", "8457"]

  # Gateway Agent — Remote command reception from messaging channels
  icdev-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway-agent
    image: icdev/gateway:latest
    container_name: icdev-gateway
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8458:8458"
    environment:
      <<: *common-env
      PORT: "8458"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8458/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "gateway-agent", "--port", "8458"]

  # ====================================================================
  # Support Tier
  # ====================================================================

  # Knowledge Agent — Self-healing patterns, ML, recommendations
  icdev-knowledge:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent-base
    image: icdev/knowledge:latest
    container_name: icdev-knowledge
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8449:8449"
    environment:
      <<: *common-env
      PORT: "8449"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8449/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "knowledge-agent", "--port", "8449"]

  # Monitor Agent — Log analysis, metrics, alerts, health checks
  icdev-monitor:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent-base
    image: icdev/monitor:latest
    container_name: icdev-monitor
    depends_on:
      icdev-init:
        condition: service_completed_successfully
    ports:
      - "8450:8450"
    environment:
      <<: *common-env
      PORT: "8450"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8450/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["tools/a2a/agent_server.py", "--agent-id", "monitor-agent", "--port", "8450"]

  # ====================================================================
  # Web Dashboard & API Gateway
  # ====================================================================

  # Web Dashboard — Flask web UI on port 5000
  icdev-dashboard:
    build:
      context: .
      dockerfile: docker/Dockerfile.dashboard
    image: icdev/dashboard:latest
    container_name: icdev-dashboard
    depends_on:
      icdev-init:
        condition: service_completed_successfully
      icdev-orchestrator:
        condition: service_healthy
    ports:
      - "5000:5000"
    environment:
      <<: *common-env
      PORT: "5000"
      # ICDEV_DASHBOARD_SECRET: "change-me"
      # ICDEV_CUI_BANNER_ENABLED: "true"
      # ICDEV_BYOK_ENABLED: "false"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:5000/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    command: ["python", "tools/dashboard/app.py", "--port", "5000"]

  # SaaS API Gateway — REST + MCP Streamable HTTP entry point
  # Note: Host port 9443 maps to container port 8443 (Dockerfile default)
  icdev-api-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.api-gateway
    image: icdev/api-gateway:latest
    container_name: icdev-api-gateway
    depends_on:
      icdev-init:
        condition: service_completed_successfully
      icdev-orchestrator:
        condition: service_healthy
    ports:
      - "9443:8443"
    environment:
      <<: *common-env
      PORT: "8443"
    env_file:
      - .env
    volumes:
      - icdev-data:/app/data
    networks:
      - icdev-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8443/health"]
      <<: *healthcheck-defaults
    logging: *default-logging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

# ======================================================================
# Networks
# ======================================================================
networks:
  icdev-net:
    driver: bridge

# ======================================================================
# Volumes
# ======================================================================
volumes:
  icdev-data:
    driver: local
