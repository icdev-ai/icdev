# CUI // SP-CTI
# ICDEV Build — Implementation workflow
# Adapted from ADW adw_build.py with dual platform support

"""
ICDEV Build — Implement the plan generated by icdev_plan.

Usage:
    python tools/ci/workflows/icdev_build.py <issue-number> <run-id>

Requires:
    - run-id from a previous icdev_plan run
    - Plan file in state

Workflow:
    1. Load state from icdev_plan
    2. Checkout feature branch
    3. Implement solution based on plan
    4. Commit implementation
    5. Push and update PR/MR
"""

import json
import os
import sys
from pathlib import Path

PROJECT_ROOT = Path(__file__).resolve().parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.ci.modules.state import ICDevState
from tools.ci.modules.git_ops import create_branch, commit_changes, finalize_git_operations
from tools.ci.modules.vcs import VCS
from tools.ci.modules.workflow_ops import (
    implement_plan,
    create_commit,
    format_issue_message,
    AGENT_IMPLEMENTOR,
)
from tools.testing.utils import setup_logger


def main():
    """Main entry point."""
    if len(sys.argv) < 3:
        print("Usage: python tools/ci/workflows/icdev_build.py <issue-number> <run-id>")
        print("\nRequires run-id from a previous icdev_plan run.")
        sys.exit(1)

    issue_number = sys.argv[1]
    run_id = sys.argv[2]

    # Load state
    state = ICDevState.load(run_id)
    logger = setup_logger(run_id, "icdev_build")
    logger.info(f"ICDEV Build starting — run_id: {run_id}, issue: #{issue_number}")

    # Initialize VCS
    try:
        vcs = VCS()
    except ValueError as e:
        logger.error(f"VCS initialization failed: {e}")
        sys.exit(1)

    # Get branch name from state
    branch_name = state.get("branch_name")
    if not branch_name:
        logger.error("No branch_name in state. Run icdev_plan first.")
        sys.exit(1)

    # Checkout branch
    success, error = create_branch(branch_name)
    if not success:
        logger.error(f"Failed to checkout branch: {error}")
        sys.exit(1)

    logger.info(f"Working on branch: {branch_name}")

    # Get plan file from state
    plan_file = state.get("plan_file")
    if not plan_file or not os.path.exists(plan_file):
        logger.error(f"Plan file not found: {plan_file}")
        sys.exit(1)

    # Implement the plan
    vcs.comment_on_issue(
        int(issue_number),
        format_issue_message(run_id, AGENT_IMPLEMENTOR, "Starting implementation"),
    )

    logger.info(f"Implementing plan: {plan_file}")
    response = implement_plan(plan_file, run_id, logger)

    if not response.success:
        logger.error(f"Implementation failed: {response.output}")
        vcs.comment_on_issue(
            int(issue_number),
            format_issue_message(run_id, AGENT_IMPLEMENTOR, f"Implementation failed: {response.output}"),
        )
        sys.exit(1)

    logger.info("Implementation completed")

    # Commit
    issue_class = state.get("issue_class", "/feature")
    issue_data = {}
    try:
        issue_data = vcs.fetch_issue(int(issue_number))
    except Exception:
        pass
    issue_json = json.dumps(issue_data)

    commit_msg, error = create_commit(
        AGENT_IMPLEMENTOR, issue_json, issue_class, run_id, logger
    )
    if error:
        logger.warning(f"Commit message generation failed, using fallback: {error}")
        commit_msg = f"{AGENT_IMPLEMENTOR}: implement plan for issue #{issue_number}"

    success, error = commit_changes(commit_msg)
    if not success:
        logger.error(f"Commit failed: {error}")
        sys.exit(1)

    logger.info(f"Committed: {commit_msg}")

    # Push and update PR/MR
    finalize_git_operations(state, logger, vcs)

    vcs.comment_on_issue(
        int(issue_number),
        format_issue_message(run_id, AGENT_IMPLEMENTOR, "Implementation committed and pushed"),
    )

    logger.info("Build phase completed")
    state.save("icdev_build")


if __name__ == "__main__":
    main()
