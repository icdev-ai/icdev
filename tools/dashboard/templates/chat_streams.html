{% extends "base.html" %}

{% block title %}Chat Streams — ICDEV Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Chat Streams</h1>
    <p class="text-muted">Multi-stream parallel agent chat — create contexts, send messages, intervene mid-stream.</p>
</div>

<!-- Stats bar -->
<div class="stat-grid" id="chat-stats">
    <div class="stat-card">
        <div class="stat-value" id="stat-active">0</div>
        <div class="stat-label">Active Chats</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-processing">0</div>
        <div class="stat-label">Processing</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-queued">0</div>
        <div class="stat-label">Queued Messages</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total Contexts</div>
    </div>
</div>

<!-- Main layout: sidebar + chat pane -->
<div style="display: flex; gap: 16px; margin-top: 16px; min-height: 500px;">
    <!-- Left sidebar: context list -->
    <div style="width: 280px; flex-shrink: 0; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); overflow-y: auto; max-height: 600px;">
        <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <strong>Contexts</strong>
            <button id="btn-new-context" class="btn btn-sm" style="font-size: 0.75rem; padding: 4px 10px; background: var(--accent-blue); color: #fff; border: none; border-radius: 4px; cursor: pointer;" title="Create new chat context">+ New</button>
        </div>
        <div id="context-list" style="padding: 4px;"></div>
    </div>

    <!-- Main chat pane -->
    <div style="flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
        <!-- Chat header -->
        <div id="chat-header" style="padding: 10px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <span id="chat-title" style="font-weight: 600;">Select or create a context</span>
            <div>
                <span id="chat-status" class="badge" style="font-size: 0.7rem;"></span>
                <button id="btn-close-context" class="btn btn-sm" style="font-size: 0.7rem; padding: 2px 8px; margin-left: 8px; display: none; background: var(--accent-red, #d44); color: #fff; border: none; border-radius: 3px; cursor: pointer;">Close</button>
            </div>
        </div>

        <!-- Message stream -->
        <div id="message-stream" style="flex: 1; overflow-y: auto; padding: 16px; min-height: 300px; max-height: 450px;"></div>

        <!-- Intervention bar (visible during processing) -->
        <div id="intervention-bar" style="display: none; padding: 8px 16px; background: var(--bg-warning, #332); border-top: 1px solid var(--border-color);">
            <div style="display: flex; gap: 8px; align-items: center;">
                <span style="font-size: 0.8rem; color: var(--accent-yellow, #fa0);">Agent is processing...</span>
                <input type="text" id="intervention-input" placeholder="Type to intervene..." style="flex: 1; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 10px; font-size: 0.85rem;">
                <button id="btn-intervene" style="background: var(--accent-yellow, #fa0); color: #000; border: none; border-radius: 4px; padding: 6px 14px; font-size: 0.8rem; cursor: pointer;">Intervene</button>
            </div>
        </div>

        <!-- Input area -->
        <div id="input-area" style="padding: 12px 16px; border-top: 1px solid var(--border-color);">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="message-input" placeholder="Type a message..." style="flex: 1; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px 12px; font-size: 0.9rem;" disabled>
                <button id="btn-send" style="background: var(--accent-blue); color: #fff; border: none; border-radius: 4px; padding: 8px 20px; font-size: 0.85rem; cursor: pointer;" disabled>Send</button>
            </div>
        </div>
    </div>
</div>

<!-- New Context Modal -->
<div id="new-context-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; width: 400px; max-width: 90vw;">
        <h3 style="margin-top: 0;">New Chat Context</h3>
        <div style="margin-bottom: 12px;">
            <label style="font-size: 0.85rem;">Title</label>
            <input type="text" id="new-ctx-title" placeholder="Chat title..." style="width: 100%; margin-top: 4px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px;">
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size: 0.85rem;">Agent Model</label>
            <select id="new-ctx-model" style="width: 100%; margin-top: 4px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px;">
                <option value="sonnet">Sonnet (Default)</option>
                <option value="opus">Opus</option>
                <option value="haiku">Haiku</option>
            </select>
        </div>
        <div style="margin-bottom: 16px;">
            <label style="font-size: 0.85rem;">System Prompt (optional)</label>
            <textarea id="new-ctx-prompt" placeholder="Custom system prompt..." rows="3" style="width: 100%; margin-top: 4px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; resize: vertical;"></textarea>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button id="btn-cancel-modal" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px 16px; cursor: pointer;">Cancel</button>
            <button id="btn-create-context" style="background: var(--accent-blue); color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer;">Create</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script defer src="{{ url_for('static', filename='js/chat_streams.js') }}"></script>
{% endblock %}
