# [TEMPLATE: CUI // SP-CTI]
# ICDEV Agent Deployments, Services, PDBs, and HPAs
# 15 agents (3 tiers) + Dashboard
# Generated by Helm -- do not edit manually.

# ======================================================================
# Orchestrator Agent — Core Tier (port 8443)
# ======================================================================
{{- if .Values.orchestrator.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-orchestrator
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: orchestrator
    icdev/tier: core
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.orchestrator.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: orchestrator
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: orchestrator
        icdev/tier: core
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: orchestrator
          image: "{{ .Values.image.repository }}/orchestrator-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.orchestrator.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.orchestrator.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: orchestrator
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: orchestrator
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-orchestrator
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: orchestrator
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.orchestrator.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: orchestrator

---
# Orchestrator PDB — Core tier: minAvailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-orchestrator-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: orchestrator
spec:
  minAvailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: orchestrator

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-orchestrator-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: orchestrator
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-orchestrator
  minReplicas: {{ .Values.autoscaling.orchestrator.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.orchestrator.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.orchestrator.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.orchestrator.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Architect Agent — Core Tier (port 8444)
# ======================================================================
{{- if .Values.architect.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-architect
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: architect
    icdev/tier: core
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.architect.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: architect
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: architect
        icdev/tier: core
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: architect
          image: "{{ .Values.image.repository }}/architect-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.architect.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.architect.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: architect
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: architect
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-architect
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: architect
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.architect.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: architect

---
# Architect PDB — Core tier: minAvailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-architect-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: architect
spec:
  minAvailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: architect

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-architect-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: architect
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-architect
  minReplicas: {{ .Values.autoscaling.architect.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.architect.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.architect.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.architect.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Builder Agent — Domain Tier (port 8445)
# ======================================================================
{{- if .Values.builder.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-builder
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: builder
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.builder.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: builder
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: builder
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: builder
          image: "{{ .Values.image.repository }}/builder-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.builder.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.builder.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: builder
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: builder
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-builder
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: builder
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.builder.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: builder

---
# Builder PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-builder-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: builder
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: builder

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-builder-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: builder
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-builder
  minReplicas: {{ .Values.autoscaling.builder.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.builder.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.builder.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.builder.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Compliance Agent — Domain Tier (port 8446)
# ======================================================================
{{- if .Values.compliance.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-compliance
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: compliance
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.compliance.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: compliance
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: compliance
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: compliance
          image: "{{ .Values.image.repository }}/compliance-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.compliance.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.compliance.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: compliance
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: compliance
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-compliance
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: compliance
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.compliance.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: compliance

---
# Compliance PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-compliance-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: compliance
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: compliance

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-compliance-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: compliance
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-compliance
  minReplicas: {{ .Values.autoscaling.compliance.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.compliance.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.compliance.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.compliance.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Security Agent — Domain Tier (port 8447)
# ======================================================================
{{- if .Values.security.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-security
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.security.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: security
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: security
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: security
          image: "{{ .Values.image.repository }}/security-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.security.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.security.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: security
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: security
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-security
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.security.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: security

---
# Security PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-security-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: security

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-security-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-security
  minReplicas: {{ .Values.autoscaling.security.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.security.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.security.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.security.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Infrastructure Agent — Domain Tier (port 8448)
# ======================================================================
{{- if .Values.infrastructure.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-infrastructure
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.infrastructure.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: infrastructure
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: infrastructure
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: infrastructure
          image: "{{ .Values.image.repository }}/infrastructure-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.infrastructure.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.infrastructure.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: infrastructure
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: infrastructure
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-infrastructure
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.infrastructure.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure

---
# Infrastructure PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-infrastructure-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: infrastructure

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-infrastructure-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-infrastructure
  minReplicas: {{ .Values.autoscaling.infrastructure.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.infrastructure.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.infrastructure.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.infrastructure.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Knowledge Agent — Support Tier (port 8449)
# ======================================================================
{{- if .Values.knowledge.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-knowledge
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: knowledge
    icdev/tier: support
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.knowledge.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: knowledge
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: knowledge
        icdev/tier: support
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: knowledge
          image: "{{ .Values.image.repository }}/knowledge-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.knowledge.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.knowledge.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: knowledge
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: knowledge
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-knowledge
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: knowledge
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.knowledge.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: knowledge

---
# Knowledge PDB — Support tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-knowledge-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: knowledge
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: knowledge

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-knowledge-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: knowledge
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-knowledge
  minReplicas: {{ .Values.autoscaling.knowledge.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.knowledge.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.knowledge.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.knowledge.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Monitor Agent — Support Tier (port 8450)
# ======================================================================
{{- if .Values.monitor.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-monitor
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitor
    icdev/tier: support
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.monitor.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: monitor
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: monitor
        icdev/tier: support
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: monitor
          image: "{{ .Values.image.repository }}/monitor-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.monitor.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.monitor.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: monitor
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: monitor
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-monitor
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitor
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.monitor.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: monitor

---
# Monitor PDB — Support tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-monitor-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitor
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: monitor

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-monitor-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitor
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-monitor
  minReplicas: {{ .Values.autoscaling.monitor.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.monitor.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.monitor.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.monitor.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# MBSE Agent — Domain Tier (port 8451)
# ======================================================================
{{- if .Values.mbse.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-mbse
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: mbse
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.mbse.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: mbse
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: mbse
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: mbse
          image: "{{ .Values.image.repository }}/mbse-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.mbse.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.mbse.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: mbse
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: mbse
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-mbse
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: mbse
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.mbse.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: mbse

---
# MBSE PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-mbse-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: mbse
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: mbse

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-mbse-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: mbse
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-mbse
  minReplicas: {{ .Values.autoscaling.mbse.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.mbse.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.mbse.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.mbse.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Modernization Agent — Domain Tier (port 8452)
# ======================================================================
{{- if .Values.modernization.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-modernization
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: modernization
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.modernization.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: modernization
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: modernization
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: modernization
          image: "{{ .Values.image.repository }}/modernization-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.modernization.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.modernization.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: modernization
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: modernization
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-modernization
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: modernization
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.modernization.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: modernization

---
# Modernization PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-modernization-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: modernization
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: modernization

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-modernization-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: modernization
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-modernization
  minReplicas: {{ .Values.autoscaling.modernization.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.modernization.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.modernization.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.modernization.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Requirements Analyst Agent — Domain Tier (port 8453)
# ======================================================================
{{- if (index .Values "requirements-analyst").enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-requirements-analyst
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: requirements-analyst
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ (index .Values "requirements-analyst").replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: requirements-analyst
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: requirements-analyst
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: requirements-analyst
          image: "{{ .Values.image.repository }}/requirements-analyst-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ (index .Values "requirements-analyst").port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml (index .Values "requirements-analyst").resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: requirements-analyst
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: requirements-analyst
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-requirements-analyst
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: requirements-analyst
spec:
  type: ClusterIP
  ports:
    - port: {{ (index .Values "requirements-analyst").port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: requirements-analyst

---
# Requirements Analyst PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-requirements-analyst-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: requirements-analyst
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: requirements-analyst

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-requirements-analyst-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: requirements-analyst
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-requirements-analyst
  minReplicas: {{ (index .Values.autoscaling "requirements-analyst").minReplicas }}
  maxReplicas: {{ (index .Values.autoscaling "requirements-analyst").maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ (index .Values.autoscaling "requirements-analyst").cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ (index .Values.autoscaling "requirements-analyst").memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Supply Chain Agent — Domain Tier (port 8454)
# ======================================================================
{{- if (index .Values "supply-chain").enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-supply-chain
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: supply-chain
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ (index .Values "supply-chain").replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: supply-chain
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: supply-chain
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: supply-chain
          image: "{{ .Values.image.repository }}/supply-chain-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ (index .Values "supply-chain").port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml (index .Values "supply-chain").resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: supply-chain
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: supply-chain
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-supply-chain
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: supply-chain
spec:
  type: ClusterIP
  ports:
    - port: {{ (index .Values "supply-chain").port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: supply-chain

---
# Supply Chain PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-supply-chain-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: supply-chain
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: supply-chain

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-supply-chain-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: supply-chain
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-supply-chain
  minReplicas: {{ (index .Values.autoscaling "supply-chain").minReplicas }}
  maxReplicas: {{ (index .Values.autoscaling "supply-chain").maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ (index .Values.autoscaling "supply-chain").cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ (index .Values.autoscaling "supply-chain").memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Simulation Agent — Domain Tier (port 8455)
# ======================================================================
{{- if .Values.simulation.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-simulation
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: simulation
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.simulation.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: simulation
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: simulation
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: simulation
          image: "{{ .Values.image.repository }}/simulation-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.simulation.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.simulation.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: simulation
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: simulation
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-simulation
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: simulation
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.simulation.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: simulation

---
# Simulation PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-simulation-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: simulation
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: simulation

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-simulation-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: simulation
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-simulation
  minReplicas: {{ .Values.autoscaling.simulation.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.simulation.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.simulation.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.simulation.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# DevSecOps Agent — Domain Tier (port 8457)
# ======================================================================
{{- if .Values.devsecops.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-devsecops
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: devsecops
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.devsecops.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: devsecops
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: devsecops
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: devsecops
          image: "{{ .Values.image.repository }}/devsecops-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.devsecops.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.devsecops.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: devsecops
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: devsecops
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-devsecops
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: devsecops
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.devsecops.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: devsecops

---
# DevSecOps PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-devsecops-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: devsecops
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: devsecops

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-devsecops-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: devsecops
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-devsecops
  minReplicas: {{ .Values.autoscaling.devsecops.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.devsecops.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.devsecops.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.devsecops.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Gateway Agent — Domain Tier (port 8458)
# ======================================================================
{{- if .Values.gateway.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-gateway
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: gateway
    icdev/tier: domain
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.gateway.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: gateway
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: gateway
        icdev/tier: domain
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: gateway
          image: "{{ .Values.image.repository }}/gateway-agent:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.gateway.port }}
              protocol: TCP
              name: agent
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          resources:
            {{- toYaml .Values.gateway.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: agent
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: gateway
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: gateway
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-gateway
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.gateway.port }}
      targetPort: agent
      protocol: TCP
      name: agent
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: gateway

---
# Gateway PDB — Domain tier: maxUnavailable=1
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-gateway-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: gateway

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-gateway-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-gateway
  minReplicas: {{ .Values.autoscaling.gateway.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.gateway.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.gateway.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.gateway.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}

---
# ======================================================================
# Dashboard — Web UI (port 5000)
# ======================================================================
{{- if .Values.dashboard.enabled | default true }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-dashboard
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: dashboard
    icdev/tier: support
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.dashboard.replicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: dashboard
  template:
    metadata:
      labels:
        {{- include "icdev.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: dashboard
        icdev/tier: support
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: dashboard
          image: "{{ .Values.image.repository }}/dashboard:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.dashboard.port }}
              protocol: TCP
              name: http
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          env:
            - name: ICDEV_DASHBOARD_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dashboard.existingSecret | default (printf "%s-dashboard-secret" .Release.Name) }}
                  key: secret_key
                  optional: true
          resources:
            {{- toYaml .Values.dashboard.resources | nindent 12 }}
          securityContext:
            {{- include "icdev.securityContext" . | nindent 12 }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 256Mi
      {{- if .Values.topologySpread.enabled }}
      topologySpreadConstraints:
        - maxSkew: {{ .Values.topologySpread.zoneSpread.maxSkew }}
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: {{ .Values.topologySpread.zoneSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: dashboard
        - maxSkew: {{ .Values.topologySpread.nodeSpread.maxSkew }}
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: {{ .Values.topologySpread.nodeSpread.whenUnsatisfiable }}
          labelSelector:
            matchLabels:
              {{- include "icdev.selectorLabels" . | nindent 14 }}
              app.kubernetes.io/component: dashboard
      {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-dashboard
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: dashboard
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.dashboard.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "icdev.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: dashboard

---
# Dashboard PDB — minAvailable=1 (user-facing)
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Release.Name }}-dashboard-pdb
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: dashboard
spec:
  minAvailable: 1
  selector:
    matchLabels:
      {{- include "icdev.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: dashboard

{{- if .Values.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Release.Name }}-dashboard-hpa
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "icdev.labels" . | nindent 4 }}
    app.kubernetes.io/component: dashboard
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}-dashboard
  minReplicas: {{ .Values.autoscaling.dashboard.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.dashboard.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.dashboard.cpuTarget }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.dashboard.memoryTarget }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 25
          periodSeconds: 60
{{- end }}
{{- end }}
